"use strict";const e="range",t="unknown";function n(e){const t=/(?:\[(.+?)\])?([^[\]]+?)$/.exec(e);if(t){const[,e,n]=t;return{context:[e,n].filter(Boolean)}}}const r=e=>e&&":"===e.value&&{},l=t=>t&&t.type===e&&{r0:t.value},o=e=>e&&"range_ternary"===e.type&&{r0:e.value},u=t=>t&&t.type===e&&{r1:t.value},a=e=>e&&"operator"===e.type&&"!"===e.value&&{},c=e=>e&&"range_beam"===e.type&&{r0:e.value},i=e=>e&&"context"===e.type?n(e.value):e&&"context_quote"===e.type?n(e.value.slice(1,-1).replace(/''/g,"'")):void 0,f=e=>e&&"range_named"===e.type&&{name:e.value},s=[[o],[l,r,u],[l],[c],[i,a,o],[i,a,l,r,u],[i,a,l],[i,a,c]],g=s.concat([[f],[i,a,f]]);function p(e,t){const n={emitRanges:!1,mergeRanges:!1,allowTernary:!1,allowNamed:!0,r1c1:!1,...t},r=re(e,K,n),l={context:[],r0:"",r1:"",name:""};r.length&&"fx_prefix"===r[0].type&&r.shift();const o=n.allowNamed?g:s;for(let e=0;e<o.length;e++){const t={...l};if(o[e].length===r.length){if(o[e].every(((e,n)=>{const l=e(r[n]);return Object.assign(t,l),l})))return t}}return null}const $=/[^0-9A-Za-z._¡¤§¨ª\u00ad¯-\uffff]/;function m(e){let t="",n=0,r=0;const l=e.context||[];for(let e=l.length;e>-1;e--){const o=l[e];if(o){t=(r%2?"["+o+"]":o)+t,n+=$.test(o),r++}}return n&&(t="'"+t.replace(/'/g,"''")+"'"),t?t+"!":t}function d(e){const t=e||"",n=t.length;let r=0;if(n>2){const e=t.charCodeAt(n-3);r+=676*(1+e-(e>95?32:0)-65)}if(n>1){const e=t.charCodeAt(n-2);r+=26*(1+e-(e>95?32:0)-65)}if(n){const e=t.charCodeAt(n-1);r+=e-(e>95?32:0)-65}return r}function x(e){return(e>=702?String.fromCharCode(((e-702)/676-0)%26+65):"")+(e>=26?String.fromCharCode(Math.floor((e/26-1)%26+65)):"")+String.fromCharCode(e%26+65)}const h=(e,t)=>(t?"$":"")+x(e),y=(e,t)=>(t?"$":"")+String(e+1);function v(e){const{top:t,left:n,bottom:r,right:l,$left:o,$right:u,$top:a,$bottom:c}=e,i=null==n,f=null==l,s=null==t,g=null==r;return 0===t&&r>=1048575||s&&g?h(n,o)+":"+h(l,u):0===n&&l>=16383||i&&f?y(t,a)+":"+y(r,c):i||s||f||!g?i||!s||f||g?i||s||!f||g?!i||s||f||g?l!==n||r!==t||u!==o||c!==a?h(n,o)+y(t,a)+":"+h(l,u)+y(r,c):h(n,o)+y(t,a):h(l,u)+y(t,a)+":"+y(r,c):h(n,o)+y(t,a)+":"+y(r,c):h(n,o)+y(r,c)+":"+h(l,u):h(n,o)+y(t,a)+":"+h(l,u)}function R(e){const t=/^(?=.)(\$(?=\D))?([A-Za-z]{0,3})?(\$)?([1-9][0-9]{0,6})?$/.exec(e);return t&&(t[2]||t[4])?[t[4]?(n=t[4],+n-1):null,t[2]?d(t[2]):null,!!t[3],!!t[1]]:null;var n}function _(e){let t=null,n=null,r=null,l=null,o=!1,u=!1,a=!1,c=!1;const[i,f,s]=e.split(":");if(s)return null;const g=R(i),p=f?R(f):null;if(!g||f&&!p)return null;if(null!=g[0]&&null!=g[1]?[t,n,o,u]=g:null==g[0]&&null!=g[1]?[,n,,u]=g:null!=g[0]&&null==g[1]&&([t,,o]=g),f)null!=p[0]&&null!=p[1]?[r,l,a,c]=p:null==p[0]&&null!=p[1]?[,l,,c]=p:null!=p[0]&&null==p[1]&&([r,,a]=p);else{if(null==t||null==n)return null;r=t,l=n,a=o,c=u}return null!=l&&(null==n||null!=n&&l<n)&&([n,l,u,c]=[l,n,c,u]),null!=r&&(null==t||null!=t&&r<t)&&([t,r,o,a]=[r,t,a,o]),{top:t,left:n,bottom:r,right:l,$top:o,$left:u,$bottom:a,$right:c}}function b(e){let{allowNamed:t=!0,allowTernary:n=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=p(e,{allowNamed:t,allowTernary:n,r1c1:!1});if(r&&(r.r0||r.name)){let e=null;return r.r0&&(e=_(r.r1?r.r0+":"+r.r1:r.r0)),r.name||e?(r.range=e,delete r.r0,delete r.r1,r):null}return null}function E(e){return m(e)+(e.name?e.name:v(e.range))}function w(e){return null==e.top&&(e.top=0,e.$top=!1),null==e.bottom&&(e.bottom=1048575,e.$bottom=!1),null==e.left&&(e.left=0,e.$left=!1),null==e.right&&(e.right=16383,e.$right=!1),e}var A={fromCol:d,toCol:x,toRelative:function(e){const{top:t,left:n,bottom:r,right:l}=e;return{top:t,left:n,bottom:r,right:l,$left:!1,$right:!1,$top:!1,$bottom:!1}},toAbsolute:function(e){const{top:t,left:n,bottom:r,right:l}=e;return{top:t,left:n,bottom:r,right:l,$left:!0,$right:!0,$top:!0,$bottom:!0}},to:v,from:_,parse:b,addBounds:w,stringify:E};const N=/^(\[(?:[^\]])+\])?([0-9A-Za-z._¡¤§¨ª\u00ad¯-\uffff]+)(?=!)/,C=/^'(?:''|[^'])*('|$)(?=!)/,T="\\$?[A-Z]{1,3}\\$?[1-9][0-9]{0,6}",I="\\$?[A-Z]{1,3}",O="\\$?[1-9][0-9]{0,6}",L=new RegExp(`^${I}:${I}`,"i"),S=new RegExp(`^${O}:${O}`,"i"),M=new RegExp(`^${T}`,"i"),Z=new RegExp(`^((${I}|${O}):${T}|${T}:(${I}|${O}))(?![\\w($.])`,"i"),q="(?:R(?:\\[[+-]?\\d+\\]|[1-9][0-9]{0,6})?)",U="(?:C(?:\\[[+-]?\\d+\\]|[1-9][0-9]{0,4})?)",W=new RegExp(`^${U}(:${U})?(?=\\W|$)`,"i"),k=new RegExp(`^${q}(:${q})?(?=\\W|$)`,"i"),z=new RegExp(`^(?:(?=[RC])${q}${U})`,"i"),B=new RegExp(`^(${q}${U}(:${U}|:${q})(?![[\\d])|(${q}|${U})(:${q}${U}))(?=\\W|$)`,"i"),F=/^[a-zA-Z\\_\u00a1-\uffff][a-zA-Z0-9\\_.?\u00a1-\uffff]{0,254}/i;function G(e,t){return n=>{const r=t.exec(n);if(r)return{type:e,value:r[0]}}}const X=/([RC])(\[?)(-?\d+)/gi,j=/(\d+|[a-zA-Z]+)/gi;function D(t,n){let r,l;if(n.r1c1){if(n.allowTernary&&(r=B.exec(t))?l={type:"range_ternary",value:r[0]}:(r=z.exec(t))?l={type:e,value:r[0]}:((r=k.exec(t))||(r=W.exec(t)))&&(l={type:"range_beam",value:r[0]}),l){for(X.lastIndex=0;null!==(r=X.exec(l.value));){const e=("R"===r[1]?1048575:16383)+(r[2]?1:0),t=parseInt(r[3],10);if(t>=e||t<=-e)return null}return l}}else if(n.allowTernary&&(r=Z.exec(t))?l={type:"range_ternary",value:r[0]}:(r=L.exec(t))||(r=S.exec(t))?l={type:"range_beam",value:r[0]}:(r=M.exec(t))&&(l={type:e,value:r[0]}),l){for(j.lastIndex=0;null!==(r=j.exec(l.value));)if(/^\d/.test(r[1])){if(parseInt(r[1],10)-1>1048575)return null}else if(d(r[1])>16383)return null;return l}}const P=[G("error",/^#(NAME\?|FIELD!|CALC!|VALUE!|REF!|DIV\/0!|NULL!|NUM!|N\/A|GETTING_DATA\b|SPILL!|UNKNOWN!|FIELD\b|CALC\b|SYNTAX\?|ERROR!)/i),G("operator",/^(<=|>=|<>|[-+/*^%&<>=]|[{},;]|[()]|@|:|!|#)/),G("bool",/^(TRUE|FALSE)\b/i),G("func",/^[A-Z_]+[A-Z\d_.]*(?=\()/i),G("newline",/^\n+/),G("whitespace",/^[ \f\r\t\v\u00a0\u1680\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]+/),G("string",/^"(?:""|[^"])*("|$)/),G("context_quote",C),G("context",N),D,G("number",/^(?:\d+(\.\d+)?(?:[eE][+-]?\d+)?|\d+)/),G("range_named",F)],K=[function(e,t){return t.r1c1?"!"===e[0]?{type:"operator",value:e[0]}:null:"!"===e[0]||":"===e[0]?{type:"operator",value:e[0]}:null},G("context_quote",C),G("context",N),D,G("range_named",F)],V={};function Y(e,t){if(e.length){const n=e[0];t[n]=t[n]||{},Y(e.slice(1),t[n])}else t.$=!0}[[e,":",e],[e],["range_beam"],["range_ternary"],["context","!",e,":",e],["context","!",e],["context","!","range_beam"],["context","!","range_ternary"],["context_quote","!",e,":",e],["context_quote","!",e],["context_quote","!","range_beam"],["context_quote","!","range_ternary"],["range_named"],["context","!","range_named"],["context_quote","!","range_named"]].forEach((e=>Y(e.concat().reverse(),V)));const H=function(e,t,n){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const l=e[n-r];if(l){const o="operator"===l.type?l.value:l.type;if(o in t)return H(e,t[o],n,r+1)}return t.$?r:0};function Q(e){const t=[];for(let n=e.length-1;n>=0;n--){let r=e[n];const l=H(e,V,n);if(l){const t=e.slice(n-l+1,n+1);r={...r},r.value=t.map((e=>e.value)).join(""),r.range&&t[0].range&&(r.range[0]=t[0].range[0]),n-=l-1}t.unshift(r)}return t}const J=(e,t)=>e&&e.type===t,ee={emitRanges:!1,mergeRanges:!0,allowTernary:!1,negativeNumbers:!0,r1c1:!1},te=e=>"range_named"===e.type||"func"===e.type,ne=e=>!J(e,"operator")||"%"===e.value||"}"===e.value||")"===e.value||"#"===e.value;function re(e,n){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const l=Object.assign({},ee,r),{emitRanges:o,mergeRanges:u,negativeNumbers:a}=l,c=[];let i=0,f=null,s=null,g=null;const p=e=>{const n=e.type===t,r=g&&g.type===t;g&&(n&&r||n&&te(g)||r&&te(e))?(g.value+=e.value,g.type=t,o&&(g.range[1]=e.range[1])):(c.push(e),g=e,"whitespace"!==e.type&&"newline"!==e.type&&(s=f,f=e))};if(/^=/.test(e)){i++,p({type:"fx_prefix",value:"=",...o?{range:[0,1]}:{}})}for(;i<e.length;){const r=i,u=e.slice(i);let $="",m="";for(let e=0;e<n.length;e++){const t=n[e](u,l);if(t){$=t.type,m=t.value,i+=m.length;break}}$||($=t,m=e[i],i++);const d={type:$,value:m,...o?{range:[r,i]}:{}};if("string"===$){const e=m.length;if('""'===m);else if('"'===m||'"'!==m[e-1])d.unterminated=!0;else if('""'!==m&&'"'===m[e-2]){let t=e-1;for(;'"'===m[t];)t--;!(t+1)^(e-t+1)%2==0&&(d.unterminated=!0)}}if(a&&"number"===$){const e=g;if(e&&J(e,"operator")&&"-"===e.value&&(!s||J(s,"fx_prefix")||!ne(s))){const e=c.pop();d.value="-"+m,o&&(d.range[0]=e.range[0]),f=s,g=c[c.length-1]}}p(d)}return u?Q(c):c}function le(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return re(e,P,t)}function oe(){let e=1;return()=>"fxg"+e++}function ue(e,t){return null==e&&null==t||e===t}function ae(e,t){return!e&&!t||String(e).toLowerCase()===String(t).toLowerCase()}function ce(e,t){return(!e.name&&!t.name||e.name===t.name)&&(!!(!e.range&&!t.range||ue(e.range.top,t.range.top)&&ue(e.range.bottom,t.range.bottom)&&ue(e.range.left,t.range.left)&&ue(e.range.right,t.range.right))&&!(!ae(e.context[0],t.context[0])||!ae(e.context[1],t.context[1])))}function ie(e,t){return t?String(e+1):e?"["+e+"]":""}function fe(e){const{r0:t,c0:n,r1:r,c1:l,$c0:o,$c1:u,$r0:a,$r1:c}=e,i=null==t,f=null==r,s=null==n,g=null==l;if(0===t&&r>=1048575||i&&f){const e=ie(n,o),t=ie(l,u);return"C"+(e===t?e:e+":C"+t)}if(0===n&&l>=16383||s&&g){const e=ie(t,a),n=ie(r,c);return"R"+(e===n?e:e+":R"+n)}const p=ie(t,a),$=ie(r,c),m=ie(n,o),d=ie(l,u);return i||f||s||g?(i?"":"R"+p)+(s?"":"C"+m)+":"+(f?"":"R"+$)+(g?"":"C"+d):p!==$||m!==d?"R"+p+"C"+m+":R"+$+"C"+d:"R"+p+"C"+m}function se(e){let t=null,n=null,r=null,l=null;const o=/^R(?:\[([+-]?\d+)\]|(\d+))?/.exec(e);o&&(o[1]?(t=parseInt(o[1],10),r=!1):o[2]?(t=parseInt(o[2],10)-1,r=!0):(t=0,r=!1),e=e.slice(o[0].length));const u=/^C(?:\[([+-]?\d+)\]|(\d+))?/.exec(e);return u&&(u[1]?(n=parseInt(u[1],10),l=!1):u[2]?(n=parseInt(u[2],10)-1,l=!0):(n=0,l=!1),e=e.slice(u[0].length)),!o&&!u||e.length?null:[t,n,r,l]}function ge(e){let t=null;const[n,r]=e.split(":",2),l=se(n);if(l){const[e,n,o,u]=l;if(!r)return null!=e&&null==n?{r0:e,c0:null,r1:e,c1:null,$r0:o,$c0:!1,$r1:o,$c1:!1}:null==e&&null!=n?{r0:null,c0:n,r1:null,c1:n,$r0:!1,$c0:u,$r1:!1,$c1:u}:{r0:e||0,c0:n||0,r1:e||0,c1:n||0,$r0:o||!1,$c0:u||!1,$r1:o||!1,$c1:u||!1};{const l=se(r);if(!l)return null;{t={};const[r,a,c,i]=l;null!=e&&null!=r?(t.r0=o===c?Math.min(e,r):e,t.$r0=o,t.r1=o===c?Math.max(e,r):r,t.$r1=c):null!=e&&null==r?(t.r0=e,t.$r0=o,t.r1=null,t.$r1=o):null==e&&null!=r?(t.r0=r,t.$r0=c,t.r1=null,t.$r1=c):null==e&&null==r&&(t.r0=null,t.$r0=!1,t.r1=null,t.$r1=!1),null!=n&&null!=a?(t.c0=u===i?Math.min(n,a):n,t.$c0=u,t.c1=u===i?Math.max(n,a):a,t.$c1=i):null!=n&&null==a?(t.c0=n,t.$c0=u,t.c1=null,t.$c1=u):null==n&&null!=a?(t.c0=a,t.$c0=i,t.c1=null,t.$c1=i):null==n&&null==a&&(t.c0=null,t.$c0=!1,t.c1=null,t.$c1=!1)}}}return t}var pe={to:fe,from:ge,parse:function(e){let{allowNamed:t=!0,allowTernary:n=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=p(e,{allowNamed:t,allowTernary:n,r1c1:!0});if(r&&(r.r0||r.name)){const e=r.r1?ge(r.r0+":"+r.r1):ge(r.r0);return r.name||e?(r.range=e,delete r.r0,delete r.r1,r):null}return null},stringify:function(e){return m(e)+(e.name?e.name:fe(e.range))}};function $e(t){return!!t&&(t.type===e||"range_beam"===t.type||"range_ternary"===t.type)}const me=(e,t,n)=>null==t?null:e?t:t-n;function de(e,t,n,r){let l=e;return null==l||t||(l=n+e,l<0&&(l=r+l+1),l>r&&(l-=r+1)),l}const xe={OPERATOR:"operator",BOOLEAN:"bool",ERROR:"error",NUMBER:"number",FUNCTION:"func",NEWLINE:"newline",WHITESPACE:"whitespace",STRING:"string",CONTEXT:"context",CONTEXT_QUOTE:"context_quote",RANGE:e,RANGE_BEAM:"range_beam",RANGE_TERNARY:"range_ternary",RANGE_NAMED:"range_named",FX_PREFIX:"fx_prefix",UNKNOWN:t};exports.MAX_COLS=16383,exports.MAX_ROWS=1048575,exports.a1=A,exports.addMeta=function(n){let{sheetName:r="",workbookName:l=""}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const o=[];let u=null;const a=oe(),c=[],i=()=>o.length+(u?1:0);return n.forEach(((n,f)=>{if(n.index=f,n.depth=i(),"("===n.value)o.push(n),n.depth=i();else if(")"===n.value){const e=o.pop();if(e){const t=a();n.groupId=t,n.depth=e.depth,e.groupId=t}else n.error=!0}else if("{"===n.value)u?n.error=!0:(u=n,n.depth=i());else if("}"===n.value){if(u){const e=a();n.groupId=e,n.depth=u.depth,u.groupId=e}else n.error=!0;u=null}else if(n.type===e||"range_beam"===n.type||"range_ternary"===n.type){const e=b(n.value,{allowNamed:!1,allowTernary:!0});if(e&&e.range){if(e.source=n.value,e.context.length){if(1===e.context.length){const t=e.context[0];e.context=t===r||t===l?[l,r]:[l,t]}}else e.context=[l,r];const t=c.find((t=>ce(t,e)));t?n.groupId=t.groupId:(e.groupId=a(),n.groupId=e.groupId,c.push(e))}}else n.type===t&&(n.error=!0)})),n},exports.fixRanges=function e(t){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{addBounds:!1};if("string"==typeof t)return e(le(t,n),n).map((e=>e.value)).join("");if(!Array.isArray(t))throw new Error("fixRanges expects an array of tokens");const{addBounds:r,r1c1:l}=n;if(l)throw new Error("fixRanges does not have an R1C1 mode");return t.map((e=>{if($e(e)){const t=b(e.value,n),l=t.range;r&&w(l);const o={...e};return o.value=E(t),o.range&&(o.range=l),o}return e}))},exports.isRange=$e,exports.isReference=function(t){return!!t&&(t.type===e||"range_beam"===t.type||"range_ternary"===t.type||"range_named"===t.type)},exports.mergeRanges=Q,exports.rc=pe,exports.tokenTypes=xe,exports.tokenize=le,exports.translateToA1=function(e,t){const n=_(t),r="string"==typeof e,l=r?le(e,{emitRanges:!1,mergeRanges:!1,allowTernary:!0,r1c1:!0}):e;return l.forEach((e=>{if($e(e)){const t={},r=ge(e.value),l=de(r.r0,r.$r0,n.top,1048575),o=de(r.r1,r.$r1,n.top,1048575);l>o?(t.top=o,t.$top=r.$r1,t.bottom=l,t.$bottom=r.$r0):(t.top=l,t.$top=r.$r0,t.bottom=o,t.$bottom=r.$r1);const u=de(r.c0,r.$c0,n.left,16383),a=de(r.c1,r.$c1,n.left,16383);u>a?(t.left=a,t.$left=r.$c1,t.right=u,t.$right=r.$c0):(t.left=u,t.$left=r.$c0,t.right=a,t.$right=r.$c1),e.value=v(t)}})),r?l.map((e=>e.value)).join(""):l},exports.translateToRC=function(e,t){const{top:n,left:r}=_(t),l="string"==typeof e,o=l?le(e,{emitRanges:!1,mergeRanges:!1,allowTernary:!0,r1c2:!1}):e;return o.forEach((e=>{if($e(e)){const t={},l=_(e.value);t.r0=me(l.$top,l.top,n),t.$r0=l.$top,t.r1=me(l.$bottom,l.bottom,n),t.$r1=l.$bottom,t.c0=me(l.$left,l.left,r),t.$c0=l.$left,t.c1=me(l.$right,l.right,r),t.$c1=l.$right,e.value=fe(t)}})),l?o.map((e=>e.value)).join(""):o};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnguanMiLCJzb3VyY2VzIjpbXSwic291cmNlc0NvbnRlbnQiOltdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIn0=
