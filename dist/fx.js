"use strict";const e="range",n="unknown";function t(e){const n=/(?:\[(.+?)\])?([^[\]]+?)$/.exec(e);if(n){const[,e,t]=n;return{context:[e,t].filter(Boolean)}}}const r=e=>e&&":"===e.value&&{},l=n=>n&&n.type===e&&{r0:n.value},o=e=>e&&"range_ternary"===e.type&&{r0:e.value},a=n=>n&&n.type===e&&{r1:n.value},u=e=>e&&"operator"===e.type&&"!"===e.value&&{},c=e=>e&&"range_beam"===e.type&&{r0:e.value},i=e=>e&&"context"===e.type?t(e.value):e&&"context_quote"===e.type?t(e.value.slice(1,-1).replace(/''/g,"'")):void 0,g=e=>e&&"range_named"===e.type&&{name:e.value},f=[[o],[l,r,a],[l],[c],[i,u,o],[i,u,l,r,a],[i,u,l],[i,u,c]],s=f.concat([[g],[i,u,g]]);function p(e,n){const t={emitRanges:!1,mergeRanges:!1,allowTernary:!1,allowNamed:!0,r1c1:!1,...n},r=re(e,K,t),l={context:[],r0:"",r1:"",name:""};r.length&&"fx_prefix"===r[0].type&&r.shift();const o=t.allowNamed?s:f;for(let e=0;e<o.length;e++){const n={...l};if(o[e].length===r.length){if(o[e].every(((e,t)=>{const l=e(r[t]);return Object.assign(n,l),l})))return n}}return null}const $=/[^0-9A-Za-z._¡¤§¨ª\u00ad¯-\uffff]/;function m(e){let n="",t=0,r=0;const l=e.context||[];for(let e=l.length;e>-1;e--){const o=l[e];if(o){n=(r%2?"["+o+"]":o)+n,t+=$.test(o),r++}}return t&&(n="'"+n.replace(/'/g,"''")+"'"),n?n+"!":n}function d(e){const n=e||"",t=n.length;let r=0;if(t>2){const e=n.charCodeAt(t-3);r+=676*(1+e-(e>95?32:0)-65)}if(t>1){const e=n.charCodeAt(t-2);r+=26*(1+e-(e>95?32:0)-65)}if(t){const e=n.charCodeAt(t-1);r+=e-(e>95?32:0)-65}return r}function h(e){return(e>=702?String.fromCharCode(((e-702)/676-0)%26+65):"")+(e>=26?String.fromCharCode(Math.floor((e/26-1)%26+65)):"")+String.fromCharCode(e%26+65)}const x=(e,n)=>(n?"$":"")+h(e),y=(e,n)=>(n?"$":"")+String(e+1);function v(e){const{top:n,left:t,bottom:r,right:l,$left:o,$right:a,$top:u,$bottom:c}=e,i=null==t,g=null==l,f=null==n,s=null==r;return 0===n&&r>=1048575||f&&s?x(t,o)+":"+x(l,a):0===t&&l>=16383||i&&g?y(n,u)+":"+y(r,c):i||f||g||!s?i||!f||g||s?i||f||!g||s?!i||f||g||s?l!==t||r!==n||a!==o||c!==u?x(t,o)+y(n,u)+":"+x(l,a)+y(r,c):x(t,o)+y(n,u):x(l,a)+y(n,u)+":"+y(r,c):x(t,o)+y(n,u)+":"+y(r,c):x(t,o)+y(r,c)+":"+x(l,a):x(t,o)+y(n,u)+":"+x(l,a)}function R(e){const n=/^(?=.)(\$(?=\D))?([A-Za-z]{0,3})?(\$)?([1-9][0-9]{0,6})?$/.exec(e);return n&&(n[2]||n[4])?[n[4]?(t=n[4],+t-1):null,n[2]?d(n[2]):null,!!n[3],!!n[1]]:null;var t}function _(e){let n=null,t=null,r=null,l=null,o=!1,a=!1,u=!1,c=!1;const[i,g,f]=e.split(":");if(f)return null;const s=R(i),p=g?R(g):null;if(!s||g&&!p)return null;if(null!=s[0]&&null!=s[1]?[n,t,o,a]=s:null==s[0]&&null!=s[1]?[,t,,a]=s:null!=s[0]&&null==s[1]&&([n,,o]=s),g)null!=p[0]&&null!=p[1]?[r,l,u,c]=p:null==p[0]&&null!=p[1]?[,l,,c]=p:null!=p[0]&&null==p[1]&&([r,,u]=p);else{if(null==n||null==t)return null;r=n,l=t,u=o,c=a}return null!=l&&(null==t||null!=t&&l<t)&&([t,l,a,c]=[l,t,c,a]),null!=r&&(null==n||null!=n&&r<n)&&([n,r,o,u]=[r,n,u,o]),{top:n,left:t,bottom:r,right:l,$top:o,$left:a,$bottom:u,$right:c}}function b(e){let{allowNamed:n=!0,allowTernary:t=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=p(e,{allowNamed:n,allowTernary:t,r1c1:!1});if(r&&(r.r0||r.name)){let e=null;return r.r0&&(e=_(r.r1?r.r0+":"+r.r1:r.r0)),r.name||e?(r.range=e,delete r.r0,delete r.r1,r):null}return null}function E(e){return m(e)+(e.name?e.name:v(e.range))}function w(e){return null==e.top&&(e.top=0,e.$top=!1),null==e.bottom&&(e.bottom=1048575,e.$bottom=!1),null==e.left&&(e.left=0,e.$left=!1),null==e.right&&(e.right=16383,e.$right=!1),e}var N={fromCol:d,toCol:h,toRelative:function(e){const{top:n,left:t,bottom:r,right:l}=e;return{top:n,left:t,bottom:r,right:l,$left:!1,$right:!1,$top:!1,$bottom:!1}},toAbsolute:function(e){const{top:n,left:t,bottom:r,right:l}=e;return{top:n,left:t,bottom:r,right:l,$left:!0,$right:!0,$top:!0,$bottom:!0}},to:v,from:_,parse:b,addBounds:w,stringify:E};const A=/^(\[(?:[^\]])+\])?([0-9A-Za-z._¡¤§¨ª\u00ad¯-\uffff]+)(?=!)/,C=/^'(?:''|[^'])*('|$)(?=!)/,T="\\$?[A-Z]{1,3}\\$?[1-9][0-9]{0,6}",I="\\$?[A-Z]{1,3}",O="\\$?[1-9][0-9]{0,6}",L=new RegExp(`^${I}:${I}`,"i"),S=new RegExp(`^${O}:${O}`,"i"),M=new RegExp(`^${T}`,"i"),Z=new RegExp(`^((${I}|${O}):${T}|${T}:(${I}|${O}))(?![\\w($.])`,"i"),q="(?:R(?:\\[[+-]?\\d+\\]|[1-9][0-9]{0,6})?)",U="(?:C(?:\\[[+-]?\\d+\\]|[1-9][0-9]{0,4})?)",B=new RegExp(`^${U}(:${U})?(?=\\W|$)`,"i"),W=new RegExp(`^${q}(:${q})?(?=\\W|$)`,"i"),X=new RegExp(`^(?:(?=[RC])${q}${U})`,"i"),k=new RegExp(`^(${q}${U}(:${U}|:${q})(?![[\\d])|(${q}|${U})(:${q}${U}))(?=\\W|$)`,"i"),z=/^[a-zA-Z\\_\u00a1-\uffff][a-zA-Z0-9\\_.?\u00a1-\uffff]{0,254}/i;function D(e,n){return t=>{const r=n.exec(t);if(r)return{type:e,value:r[0]}}}const F=/([RC])(\[?)(-?\d+)/gi,G=/(\d+|[a-zA-Z]+)/gi;function j(n,t){let r,l;if(t.r1c1){if(t.allowTernary&&(r=k.exec(n))?l={type:"range_ternary",value:r[0]}:(r=X.exec(n))?l={type:e,value:r[0]}:((r=W.exec(n))||(r=B.exec(n)))&&(l={type:"range_beam",value:r[0]}),l){for(F.lastIndex=0;null!==(r=F.exec(l.value));){const e=("R"===r[1]?1048575:16383)+(r[2]?1:0),n=parseInt(r[3],10);if(n>=e||n<=-e)return null}return l}}else if(t.allowTernary&&(r=Z.exec(n))?l={type:"range_ternary",value:r[0]}:(r=L.exec(n))||(r=S.exec(n))?l={type:"range_beam",value:r[0]}:(r=M.exec(n))&&(l={type:e,value:r[0]}),l){for(G.lastIndex=0;null!==(r=G.exec(l.value));)if(/^\d/.test(r[1])){if(parseInt(r[1],10)-1>1048575)return null}else if(d(r[1])>16383)return null;return l}}const P=[D("error",/^#(NAME\?|FIELD!|CALC!|VALUE!|REF!|DIV\/0!|NULL!|NUM!|N\/A|GETTING_DATA\b|SPILL!|UNKNOWN!|FIELD\b|CALC\b|SYNTAX\?|ERROR!|CONNECT!|BLOCKED!|EXTERNAL!)/i),D("operator",/^(<=|>=|<>|[-+/*^%&<>=]|[{},;]|[()]|@|:|!|#)/),D("func",/^[A-Z_]+[A-Z\d_.]*(?=\()/i),D("bool",/^(TRUE|FALSE)\b/i),D("newline",/^\n+/),D("whitespace",/^[ \f\r\t\v\u00a0\u1680\u2000-\u200a\u2028\u2029\u202f\u205f\u3000\ufeff]+/),D("string",/^"(?:""|[^"])*("|$)/),D("context_quote",C),D("context",A),j,D("number",/^(?:\d+(\.\d+)?(?:[eE][+-]?\d+)?|\d+)/),D("range_named",z)],K=[function(e,n){return n.r1c1?"!"===e[0]?{type:"operator",value:e[0]}:null:"!"===e[0]||":"===e[0]?{type:"operator",value:e[0]}:null},D("context_quote",C),D("context",A),j,D("range_named",z)],V={};function Y(e,n){if(e.length){const t=e[0];n[t]=n[t]||{},Y(e.slice(1),n[t])}else n.$=!0}[[e,":",e],[e],["range_beam"],["range_ternary"],["context","!",e,":",e],["context","!",e],["context","!","range_beam"],["context","!","range_ternary"],["context_quote","!",e,":",e],["context_quote","!",e],["context_quote","!","range_beam"],["context_quote","!","range_ternary"],["range_named"],["context","!","range_named"],["context_quote","!","range_named"]].forEach((e=>Y(e.concat().reverse(),V)));const H=function(e,n,t){let r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;const l=e[t-r];if(l){const o="operator"===l.type?l.value:l.type;if(o in n)return H(e,n[o],t,r+1)}return n.$?r:0};function Q(e){const n=[];for(let t=e.length-1;t>=0;t--){let r=e[t];const l=H(e,V,t);if(l){const n=e.slice(t-l+1,t+1);r={...r},r.value=n.map((e=>e.value)).join(""),r.range&&n[0].range&&(r.range[0]=n[0].range[0]),t-=l-1}n.unshift(r)}return n}const J=(e,n)=>e&&e.type===n,ee={emitRanges:!1,mergeRanges:!0,allowTernary:!1,negativeNumbers:!0,r1c1:!1},ne=e=>"range_named"===e.type||"func"===e.type,te=e=>!J(e,"operator")||"%"===e.value||"}"===e.value||")"===e.value||"#"===e.value;function re(e,t){let r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const l=Object.assign({},ee,r),{emitRanges:o,mergeRanges:a,negativeNumbers:u}=l,c=[];let i=0,g=null,f=null,s=null;const p=e=>{const t=e.type===n,r=s&&s.type===n;s&&(t&&r||t&&ne(s)||r&&ne(e))?(s.value+=e.value,s.type=n,o&&(s.range[1]=e.range[1])):(c.push(e),s=e,"whitespace"!==e.type&&"newline"!==e.type&&(f=g,g=e))};if(/^=/.test(e)){i++,p({type:"fx_prefix",value:"=",...o?{range:[0,1]}:{}})}for(;i<e.length;){const r=i,a=e.slice(i);let $="",m="";for(let e=0;e<t.length;e++){const n=t[e](a,l);if(n){$=n.type,m=n.value,i+=m.length;break}}$||($=n,m=e[i],i++);const d={type:$,value:m,...o?{range:[r,i]}:{}};if("string"===$){const e=m.length;if('""'===m);else if('"'===m||'"'!==m[e-1])d.unterminated=!0;else if('""'!==m&&'"'===m[e-2]){let n=e-1;for(;'"'===m[n];)n--;!(n+1)^(e-n+1)%2==0&&(d.unterminated=!0)}}if(u&&"number"===$){const e=s;if(e&&J(e,"operator")&&"-"===e.value&&(!f||J(f,"fx_prefix")||!te(f))){const e=c.pop();d.value="-"+m,o&&(d.range[0]=e.range[0]),g=f,s=c[c.length-1]}}p(d)}return a?Q(c):c}function le(e){let n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return re(e,P,n)}function oe(){let e=1;return()=>"fxg"+e++}function ae(e,n){return null==e&&null==n||e===n}function ue(e,n){return!e&&!n||String(e).toLowerCase()===String(n).toLowerCase()}function ce(e,n){return(!e.name&&!n.name||e.name===n.name)&&(!!(!e.range&&!n.range||ae(e.range.top,n.range.top)&&ae(e.range.bottom,n.range.bottom)&&ae(e.range.left,n.range.left)&&ae(e.range.right,n.range.right))&&!(!ue(e.context[0],n.context[0])||!ue(e.context[1],n.context[1])))}function ie(e,n){return n?String(e+1):e?"["+e+"]":""}function ge(e){const{r0:n,c0:t,r1:r,c1:l,$c0:o,$c1:a,$r0:u,$r1:c}=e,i=null==n,g=null==r,f=null==t,s=null==l;if(0===n&&r>=1048575||i&&g){const e=ie(t,o),n=ie(l,a);return"C"+(e===n?e:e+":C"+n)}if(0===t&&l>=16383||f&&s){const e=ie(n,u),t=ie(r,c);return"R"+(e===t?e:e+":R"+t)}const p=ie(n,u),$=ie(r,c),m=ie(t,o),d=ie(l,a);return i||g||f||s?(i?"":"R"+p)+(f?"":"C"+m)+":"+(g?"":"R"+$)+(s?"":"C"+d):p!==$||m!==d?"R"+p+"C"+m+":R"+$+"C"+d:"R"+p+"C"+m}function fe(e){let n=null,t=null,r=null,l=null;const o=/^R(?:\[([+-]?\d+)\]|(\d+))?/.exec(e);o&&(o[1]?(n=parseInt(o[1],10),r=!1):o[2]?(n=parseInt(o[2],10)-1,r=!0):(n=0,r=!1),e=e.slice(o[0].length));const a=/^C(?:\[([+-]?\d+)\]|(\d+))?/.exec(e);return a&&(a[1]?(t=parseInt(a[1],10),l=!1):a[2]?(t=parseInt(a[2],10)-1,l=!0):(t=0,l=!1),e=e.slice(a[0].length)),!o&&!a||e.length?null:[n,t,r,l]}function se(e){let n=null;const[t,r]=e.split(":",2),l=fe(t);if(l){const[e,t,o,a]=l;if(!r)return null!=e&&null==t?{r0:e,c0:null,r1:e,c1:null,$r0:o,$c0:!1,$r1:o,$c1:!1}:null==e&&null!=t?{r0:null,c0:t,r1:null,c1:t,$r0:!1,$c0:a,$r1:!1,$c1:a}:{r0:e||0,c0:t||0,r1:e||0,c1:t||0,$r0:o||!1,$c0:a||!1,$r1:o||!1,$c1:a||!1};{const l=fe(r);if(!l)return null;{n={};const[r,u,c,i]=l;null!=e&&null!=r?(n.r0=o===c?Math.min(e,r):e,n.$r0=o,n.r1=o===c?Math.max(e,r):r,n.$r1=c):null!=e&&null==r?(n.r0=e,n.$r0=o,n.r1=null,n.$r1=o):null==e&&null!=r?(n.r0=r,n.$r0=c,n.r1=null,n.$r1=c):null==e&&null==r&&(n.r0=null,n.$r0=!1,n.r1=null,n.$r1=!1),null!=t&&null!=u?(n.c0=a===i?Math.min(t,u):t,n.$c0=a,n.c1=a===i?Math.max(t,u):u,n.$c1=i):null!=t&&null==u?(n.c0=t,n.$c0=a,n.c1=null,n.$c1=a):null==t&&null!=u?(n.c0=u,n.$c0=i,n.c1=null,n.$c1=i):null==t&&null==u&&(n.c0=null,n.$c0=!1,n.c1=null,n.$c1=!1)}}}return n}function pe(e){let{allowNamed:n=!0,allowTernary:t=!1}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const r=p(e,{allowNamed:n,allowTernary:t,r1c1:!0});if(r&&(r.r0||r.name)){const e=r.r1?se(r.r0+":"+r.r1):se(r.r0);return r.name||e?(r.range=e,delete r.r0,delete r.r1,r):null}return null}function $e(e){return m(e)+(e.name?e.name:ge(e.range))}var me={to:ge,from:se,parse:pe,stringify:$e};function de(n){return!!n&&(n.type===e||"range_beam"===n.type||"range_ternary"===n.type)}const he=(e,n,t)=>null==n?null:e?n:n-t,xe={emitRanges:!1,mergeRanges:!1,allowTernary:!0,r1c1:!1};function ye(e,n,t,r){let l=e;return null==l||n||(l=t+e,l<0&&(l=r+l+1),l>r&&(l-=r+1)),l}const ve={OPERATOR:"operator",BOOLEAN:"bool",ERROR:"error",NUMBER:"number",FUNCTION:"func",NEWLINE:"newline",WHITESPACE:"whitespace",STRING:"string",CONTEXT:"context",CONTEXT_QUOTE:"context_quote",RANGE:e,RANGE_BEAM:"range_beam",RANGE_TERNARY:"range_ternary",RANGE_NAMED:"range_named",FX_PREFIX:"fx_prefix",UNKNOWN:n};exports.MAX_COLS=16383,exports.MAX_ROWS=1048575,exports.a1=N,exports.addMeta=function(t){let{sheetName:r="",workbookName:l=""}=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const o=[];let a=null;const u=oe(),c=[],i=()=>o.length+(a?1:0);return t.forEach(((t,g)=>{if(t.index=g,t.depth=i(),"("===t.value)o.push(t),t.depth=i();else if(")"===t.value){const e=o.pop();if(e){const n=u();t.groupId=n,t.depth=e.depth,e.groupId=n}else t.error=!0}else if("{"===t.value)a?t.error=!0:(a=t,t.depth=i());else if("}"===t.value){if(a){const e=u();t.groupId=e,t.depth=a.depth,a.groupId=e}else t.error=!0;a=null}else if(t.type===e||"range_beam"===t.type||"range_ternary"===t.type){const e=b(t.value,{allowNamed:!1,allowTernary:!0});if(e&&e.range){if(e.source=t.value,e.context.length){if(1===e.context.length){const n=e.context[0];e.context=n===r||n===l?[l,r]:[l,n]}}else e.context=[l,r];const n=c.find((n=>ce(n,e)));n?t.groupId=n.groupId:(e.groupId=u(),t.groupId=e.groupId,c.push(e))}}else t.type===n&&(t.error=!0)})),t},exports.fixRanges=function e(n){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{addBounds:!1};if("string"==typeof n)return e(le(n,t),t).map((e=>e.value)).join("");if(!Array.isArray(n))throw new Error("fixRanges expects an array of tokens");const{addBounds:r,r1c1:l}=t;if(l)throw new Error("fixRanges does not have an R1C1 mode");return n.map((e=>{if(de(e)){const n=b(e.value,t),l=n.range;r&&w(l);const o={...e};return o.value=E(n),o.range&&(o.range=l),o}return e}))},exports.isRange=de,exports.isReference=function(n){return!!n&&(n.type===e||"range_beam"===n.type||"range_ternary"===n.type||"range_named"===n.type)},exports.mergeRanges=Q,exports.rc=me,exports.tokenTypes=ve,exports.tokenize=le,exports.translateToA1=function(e,n){const t=_(n),r="string"==typeof e,l=r?le(e,{emitRanges:!1,mergeRanges:!1,allowTernary:!0,r1c1:!0}):e;let o=0;return l.forEach((e=>{if(de(e)){const n=e.value,r=pe(n,{allowTernary:!0}),l=r.range,a={},u=ye(l.r0,l.$r0,t.top,1048575),c=ye(l.r1,l.$r1,t.top,1048575);u>c?(a.top=c,a.$top=l.$r1,a.bottom=u,a.$bottom=l.$r0):(a.top=u,a.$top=l.$r0,a.bottom=c,a.$bottom=l.$r1);const i=ye(l.c0,l.$c0,t.left,16383),g=ye(l.c1,l.$c1,t.left,16383);i>g?(a.left=g,a.$left=l.$c1,a.right=i,a.$right=l.$c0):(a.left=i,a.$left=l.$c0,a.right=g,a.$right=l.$c1),r.range=a,e.value=E(r),e.range&&(e.range[0]+=o,o+=e.value.length-n.length,e.range[1]+=o)}else o&&e.range&&(e.range[0]+=o,e.range[1]+=o)})),r?l.map((e=>e.value)).join(""):l},exports.translateToRC=function(e,n){const{top:t,left:r}=_(n),l="string"==typeof e,o=l?le(e,xe):e;let a=0;return o.forEach((e=>{if(de(e)){const n=e.value,l=b(n,{allowTernary:!0}),o=l.range,u={};u.r0=he(o.$top,o.top,t),u.r1=he(o.$bottom,o.bottom,t),u.c0=he(o.$left,o.left,r),u.c1=he(o.$right,o.right,r),u.$r0=o.$top,u.$r1=o.$bottom,u.$c0=o.$left,u.$c1=o.$right,l.range=u,e.value=$e(l),e.range&&(e.range[0]+=a,a+=e.value.length-n.length,e.range[1]+=a)}else a&&e.range&&(e.range[0]+=a,e.range[1]+=a)})),l?o.map((e=>e.value)).join(""):o};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZnguanMiLCJzb3VyY2VzIjpbXSwic291cmNlc0NvbnRlbnQiOltdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiIn0=
